services:
  moltbot-gateway:
    image: ghcr.io/moltbot/moltbot:${MOLTBOT_VERSION:-latest}
    container_name: moltbot-gateway
    restart: unless-stopped
    ports:
      - "18789:18789"
      - "18790:18790"
    environment:
      - HOME=/home/node
      - NODE_ENV=production
      - CLAWDBOT_GATEWAY_BIND=0.0.0.0
      - CLAWDBOT_GATEWAY_TOKEN=${CLAWDBOT_GATEWAY_TOKEN}
      - CLAWDBOT_GATEWAY_PASSWORD=${CLAWDBOT_GATEWAY_PASSWORD:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Optional: Discord channel
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      # Optional: Telegram channel
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
    volumes:
      - moltbot-config:/home/node/.clawdbot
      - moltbot-workspace:/home/node/clawd
      - moltbot-home:/home/node
    networks:
      - moltbot-network
      - magento-network
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.moltbot.rule=Host(`moltbot.${DOMAIN:-example.com}`)"
      - "traefik.http.routers.moltbot.entrypoints=websecure"
      - "traefik.http.routers.moltbot.tls.certresolver=letsencrypt"
      - "traefik.http.services.moltbot.loadbalancer.server.port=18789"
      # WebSocket support
      - "traefik.http.routers.moltbot-ws.rule=Host(`moltbot.${DOMAIN:-example.com}`)"
      - "traefik.http.routers.moltbot-ws.entrypoints=websecure"
      - "traefik.http.routers.moltbot-ws.tls.certresolver=letsencrypt"
      - "traefik.http.middlewares.moltbot-ws.headers.customrequestheaders.Connection=Upgrade"
      - "traefik.http.middlewares.moltbot-ws.headers.customrequestheaders.Upgrade=websocket"
    command: ["node", "dist/index.js", "gateway"]

  moltbot-cli:
    image: ghcr.io/moltbot/moltbot:${MOLTBOT_VERSION:-latest}
    container_name: moltbot-cli
    profiles:
      - cli
    stdin_open: true
    tty: true
    environment:
      - HOME=/home/node
      - CLAWDBOT_GATEWAY_TOKEN=${CLAWDBOT_GATEWAY_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - moltbot-config:/home/node/.clawdbot
      - moltbot-workspace:/home/node/clawd
      - moltbot-home:/home/node
    networks:
      - moltbot-network
    entrypoint: ["node", "dist/index.js"]

  # Optional: Watchtower for automatic updates
  watchtower:
    image: containrrr/watchtower
    container_name: moltbot-watchtower
    profiles:
      - autoupdate
    restart: unless-stopped
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=3600
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_MONITOR_ONLY=${WATCHTOWER_MONITOR_ONLY:-false}
      - WATCHTOWER_NOTIFICATIONS=${WATCHTOWER_NOTIFICATIONS:-}
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: moltbot-gateway

volumes:
  moltbot-config:
    name: moltbot-config
  moltbot-workspace:
    name: moltbot-workspace
  moltbot-home:
    name: moltbot-home

networks:
  moltbot-network:
    driver: bridge
    name: moltbot-network
  magento-network:
    external: true
    name: magento-network
