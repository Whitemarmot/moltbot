services:
  moltbot-gateway:
    build:
      context: ./moltbot-src
      dockerfile: Dockerfile
    image: moltbot:local
    container_name: moltbot-gateway
    restart: unless-stopped
    ports:
      - "18789:18789"
      - "18790:18790"
    environment:
      - HOME=/home/node
      - NODE_ENV=production
      - CLAWDBOT_GATEWAY_BIND=0.0.0.0
      - CLAWDBOT_GATEWAY_TOKEN=${CLAWDBOT_GATEWAY_TOKEN}
      - CLAWDBOT_GATEWAY_PASSWORD=${CLAWDBOT_GATEWAY_PASSWORD:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
    volumes:
      - moltbot-config:/home/node/.moltbot
      - moltbot-workspace:/home/node/moltbot
      - moltbot-home:/home/node
    networks:
      - moltbot-network
      - magento-network
      - traefik-public
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      # Gateway API (WebSocket)
      - "traefik.http.routers.moltbot-api.rule=Host(`moltbot.${DOMAIN:-example.com}`)"
      - "traefik.http.routers.moltbot-api.entrypoints=websecure"
      - "traefik.http.routers.moltbot-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.moltbot-api.service=moltbot-api"
      - "traefik.http.services.moltbot-api.loadbalancer.server.port=18789"
      # Dashboard UI
      - "traefik.http.routers.moltbot-dashboard.rule=Host(`moltbot-ui.${DOMAIN:-example.com}`)"
      - "traefik.http.routers.moltbot-dashboard.entrypoints=websecure"
      - "traefik.http.routers.moltbot-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.moltbot-dashboard.service=moltbot-dashboard"
      - "traefik.http.services.moltbot-dashboard.loadbalancer.server.port=18790"
    command: ["node", "dist/index.js", "gateway"]

  moltbot-cli:
    image: moltbot:local
    container_name: moltbot-cli
    profiles:
      - cli
    stdin_open: true
    tty: true
    environment:
      - HOME=/home/node
      - CLAWDBOT_GATEWAY_TOKEN=${CLAWDBOT_GATEWAY_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - moltbot-config:/home/node/.moltbot
      - moltbot-workspace:/home/node/moltbot
      - moltbot-home:/home/node
    networks:
      - moltbot-network
    entrypoint: ["node", "dist/index.js"]

volumes:
  moltbot-config:
    name: moltbot-config
  moltbot-workspace:
    name: moltbot-workspace
  moltbot-home:
    name: moltbot-home

networks:
  moltbot-network:
    driver: bridge
    name: moltbot-network
  magento-network:
    external: true
    name: magento-network
  traefik-public:
    external: true
